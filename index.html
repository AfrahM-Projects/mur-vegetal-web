<!-- Ajouter dans <head> ou juste avant la fin de </body> -->
<script src="https://unpkg.com/paho-mqtt/mqttws31.min.js"></script>

<script>
  const identifiants = {
    utilisateur: "admin",
    motdepasse: "1234"
  };

  let client; // MQTT client

  function verifierConnexion() {
    const login = document.getElementById("login").value;
    const motdepasse = document.getElementById("motdepasse").value;

    if (login === identifiants.utilisateur && motdepasse === identifiants.motdepasse) {
      document.getElementById("loginBox").classList.remove("active");
      document.getElementById("appInterface").classList.add("active");
      demarrerMQTT(); // on lance la connexion MQTT au lieu de WebSocket
    } else {
      document.getElementById("erreur").textContent = "‚ùå Identifiants incorrects !";
    }
  }

  function demarrerMQTT() {
    const etatSysteme = document.getElementById("etatSysteme").querySelector("span");
    const humidite = document.getElementById("humidite").querySelector("span");
    const luminosite = document.getElementById("luminosite").querySelector("span");
    const air = document.getElementById("air").querySelector("span");
    const temperature = document.getElementById("temperature").querySelector("span");
    const derniereMaj = document.getElementById("derniereMaj");

    // Connexion au broker MQTT de ChirpStack (adapter l'IP/port si besoin)
    // IMPORTANT: Le broker doit accepter la connexion WebSocket MQTT sur ce port (souvent 8083)
    const brokerUrl = "ws://192.168.5.120:8083/mqtt";
    const clientId = "webclient_" + Math.random().toString(16).substr(2, 8);

    client = new Paho.MQTT.Client(brokerUrl, clientId);

    client.onConnectionLost = (responseObject) => {
      etatSysteme.textContent = "√âtat du syst√®me : Connexion MQTT perdue ‚ùå";
      if (responseObject.errorCode !== 0) {
        console.error("Connexion MQTT perdue:", responseObject.errorMessage);
      }
    };

    client.onMessageArrived = (message) => {
      try {
        // Le payload arrive en base64 ou JSON selon ChirpStack, √† adapter !
        // Ici, on suppose que ChirpStack publie un JSON clair dans le topic.
        const data = JSON.parse(message.payloadString);

        if (data.humidite) humidite.textContent = "Humidit√© : " + data.humidite + " %";
        if (data.luminosite) luminosite.textContent = "Luminosit√© : " + data.luminosite + " lux";
        if (data.air) air.textContent = "Qualit√© de l'air : " + data.air;
        if (data.temperature) temperature.textContent = "Temp√©rature : " + data.temperature + " ¬∞C";
        derniereMaj.textContent = "Derni√®re mise √† jour : " + new Date().toLocaleString();
        etatSysteme.textContent = "√âtat du syst√®me : Donn√©es mises √† jour ‚úÖ";
      } catch (e) {
        console.error("Erreur parsing message MQTT :", e);
      }
    };

    client.connect({
      onSuccess: () => {
        etatSysteme.textContent = "√âtat du syst√®me : Connect√© au broker MQTT ‚úÖ";

        // S‚Äôabonner au topic ChirpStack o√π les donn√©es arrivent, adapte ce topic :
        // Exemple donn√© dans ta question:
        // "application/f0ce757d-5f90-46d9-aebd-b056d9ef74c1/device/2311111111111123/event/up"
        const topic = "application/f0ce757d-5f90-46d9-aebd-b056d9ef74c1/device/2311111111111123/event/up";

        client.subscribe(topic, {
          qos: 0,
          onSuccess: () => {
            console.log("Abonn√© au topic MQTT:", topic);
          },
          onFailure: (err) => {
            console.error("Erreur abonnement topic MQTT:", err);
          }
        });
      },
      onFailure: (err) => {
        etatSysteme.textContent = "√âtat du syst√®me : √âchec connexion MQTT ‚ùå";
        console.error("Erreur connexion MQTT:", err);
      }
    });
  }

  function chargerDonnees() {
    console.log("üîÑ Rafra√Æchir manuellement (d√©sactiv√© si MQTT actif)");
  }

  function activerArrosage() {
    alert("Syst√®me d‚Äôarrosage activ√© üíß");
    document.getElementById("etatSysteme").querySelector("span").textContent = "√âtat du syst√®me : Arrosage en cours...";
  }

  function toggleMode() {
    document.body.classList.toggle("dark-mode");
  }

  function seDeconnecter() {
    if (client && client.isConnected()) {
      client.disconnect();
    }
    document.getElementById("appInterface").classList.remove("active");
    document.getElementById("loginBox").classList.add("active");
    document.getElementById("login").value = "";
    document.getElementById("motdepasse").value = "";
    document.getElementById("erreur").textContent = "";
    document.body.classList.remove("dark-mode");
  }
</script>
